<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>ComputeShader-URP沙地/雪地上脚印/车辙效果实现 | EmiteInna</title><meta name="author" content="EmiteInna"><meta name="copyright" content="EmiteInna"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="参照各个效果实现了一个自己的雪地上轨迹效果，用到了CS，所以在牺牲了兼容性的情况下提高了一些性能，早期作品，当个参考就好。">
<meta property="og:type" content="article">
<meta property="og:title" content="ComputeShader-URP沙地&#x2F;雪地上脚印&#x2F;车辙效果实现">
<meta property="og:url" content="http://emiteinna.github.io/game/demo1/index.html">
<meta property="og:site_name" content="EmiteInna">
<meta property="og:description" content="参照各个效果实现了一个自己的雪地上轨迹效果，用到了CS，所以在牺牲了兼容性的情况下提高了一些性能，早期作品，当个参考就好。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://emiteinna.github.io/image/images/qt03.jpg">
<meta property="article:published_time" content="2023-02-20T04:34:32.000Z">
<meta property="article:modified_time" content="2023-03-19T17:06:00.972Z">
<meta property="article:author" content="EmiteInna">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://emiteinna.github.io/image/images/qt03.jpg"><link rel="shortcut icon" href="/image/images/knifesmall.png"><link rel="canonical" href="http://emiteinna.github.io/game/demo1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ComputeShader-URP沙地/雪地上脚印/车辙效果实现',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-03-20 01:06:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/cursor.min.css"><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="\assets\css\APlayer.min.css" class="aplayer-style-marker">
<script src="\assets\js\APlayer.min.js" class="aplayer-script-marker"></script>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/images/knifesmall.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">86</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/images/qt03.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="EmiteInna"><img class="site-icon" src="/image/images/knife.png"/><span class="site-name">EmiteInna</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ComputeShader-URP沙地/雪地上脚印/车辙效果实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-02-20T04:34:32.000Z" title="Created 2023-02-20 12:34:32">2023-02-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-03-19T17:06:00.972Z" title="Updated 2023-03-20 01:06:00">2023-03-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/TA/">TA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>35min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ComputeShader-URP沙地/雪地上脚印/车辙效果实现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>参照各个效果实现了一个自己的雪地上轨迹效果，用到了CS，所以在牺牲了兼容性的情况下提高了一些性能，早期作品，当个参考就好。</p>
</blockquote>

        <div id="aplayer-mmgTKpSn" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":false,"showlrc":0,"mode":"random","mutex":true,"theme":"#e6d0b2","preload":"metadata","listmaxheight":"513px","music":[{"title":"玻璃の空","author":"小清水亚美","url":"/kuru/music/glasssora.mp3","pic":""}]};
				  options.element = document.getElementById("aplayer-mmgTKpSn");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>

<h1 id="最☆终★效☆果"><a href="#最☆终★效☆果" class="headerlink" title="最☆终★效☆果"></a>最☆终★效☆果</h1><p><img src="/image/images/games/demo1/gif05.gif" alt="最终效果"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本次算是自己给自己的一个综合任务，目标是做出类似雪山赛车的轨迹效果，并且支持在凹凸不平的大型场景中运行，尽可能优化性能，当然能否用作落地还需探讨。<br>出于性能的分析，从不同平台分析可以用到的方法，如果是在PC端的话，用CS做位移贴图+曲面细分着色器应该是最好的方法吧，虽然兼容性可能并不那么强。<br>等完全做完了之后回头看看，这篇反而更像是笔记了，有一种成长的美（草）。<br>2.24补：第一节和第二节的两张gif由于当时没有压缩，事后已经调没了，所以没有补录，大家注意流量，红豆泥私密马赛orz。</p>
<h1 id="轨迹效果-轨迹消失"><a href="#轨迹效果-轨迹消失" class="headerlink" title="轨迹效果+轨迹消失"></a>轨迹效果+轨迹消失</h1><p><img src="/image/images/games/demo1/gif01.gif" alt="图"></p>
<p>（从美术的角度来说并不好看，并且有明显的锯齿，只是实现个轨迹+消失的效果而已）<br>由于方法定在了ComputeShader（简称为cs），所以核心思路肯定是在C#脚本中给cs传值然后处理RenderTexture的计算，最后利用得到的RenderTexture来实现效果。<br>在这一部分我希望可定义的参数有：轨迹的颜色、轨迹的大小、轨迹消失的时间。沙漠和雪原这种地图都是非常庞大的，而轨迹是一个和地图大小无关的细节型纹理， 如果用整张地图的大纹理作为计算目标显然非常消耗性能，几乎不可能实现。但是脚印存在时间是有限的，所以很容易想到可以创建一个跟随着玩家的纹理，只要玩家在全速奔跑的时候离之前踩过即将消失的脚印之间的距离不超过 这个纹理的长度，就可以用这个纹理代替大地图来实现运算。这里用来跟随的物体肯定是选用平面来测试最为直观，平面的Transform大小也可以为我们更改纹理大小起到一个直观显示的帮助作用。<br>而当选用跟随玩家的平面来进行制作的话，就代表着玩家可以看做永远处在纹理中心点的位置，在脚本中我们可以根据玩家位移的位置和平面的大小来算出在此刻处在纹理(x,y)位置的点之前一帧处于什么位置。</p>
<p><img src="/image/images/games/demo1/image02.png" alt="图"></p>
<p>其中movement指玩家在此帧中的移动向量，texSize指用来储存轨迹的纹理大小，越大纹理的精度越高，支持的轨迹范围也越大，scale是平面的lossyscale。值得一提的是，当向量中某通道的值特别低时可以考虑将其归零，避免因为精度导致的即使人物不动轨迹也在移动的问题，如果是人物也在移动的话虽然也会有精度问题，但没那么容易看出来，精度问题是非常难以避免的。<br>为了完成迭代，我们需要两张Rt，一张targetRT作为计算的结果来使用，一张originalRT用来储存当前帧的结果供下一帧来使用，后一张属于临时纹理，所以只需要用Temporary就可以了。<br>在cs中，由于玩家在纹理中的位置永远处于中心，所以用当前位置和中心位置作距离，再与设定的轨迹的大小比较就能判断是否要在该位置添加新的轨迹，如果需要添加新的轨迹，直接在targetRT里修改。</p>
<figure class="highlight plaintext"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">float2 center=float2(Width/2,Height/2);</span><br><span class="line">float at=(TrailSize-LengthAbs(center,id.xy))/TrailSize;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在脚本中用Graphics.Blit()函数把targetRT赋给originalRT，就能完成一次迭代。</p>
<p>但是很显然，现在的效果是走出来的轨迹不会消失，因为我们并没有计算消失的逻辑。一般来说，雪地中的脚印消失效果都是： 踩下去之后，脚印持续一段时间t1，然后在另一段时间t2内逐渐消失，我希望能够精确地控制t1和t2，但是在cs中能获取到的只有当前位置目前的颜色，仅靠这个参数是不够完成目标效果的， 我们还需要获取当前这个脚印已经存在多久了，这样就能完成效果，而纹理中每一个位置的时间都需要记录，我姑且开了一张新的Rt来储存时间，这样多浪费了很多空间，这些空间将会在之后的内容进行优化。<br>有了时间之后就可以实现上述的效果了，我们在当前位置重新生成脚印的范围内把时间设置为1，然后在各个位置让时间以参数设定的速率减少，然后在时间小于一定的阈值之后用线性插值来更新脚印的透明度，当时间归零时脚印的透明度也归零，这个过程可以用一个乘法的trick来避免使用if语句。</p>
<figure class="highlight plaintext"><figcaption><span>测试</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Timer[id.xy]=max(0,Timer[id.xy]-Fade);</span><br><span class="line">Result[id.xy]=lerp(ColorSnow,ColorTrail,Timer[id.xy].r*50);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样我们就通过C#脚本和cs完成了轨迹的生成，接下来就是轨迹的使用，如果是平地地形的话我们大可以直接把这个平面的材质底色换成雪地的颜色直接显示出来，但是在凹凸起伏的地图上这样就行不通，不过由于玩家的位置和平面的大小都是已知的参数，我们只需要在雪地地形的材质片元着色器上利用世界坐标来计算一下就能把轨迹叠上去。</p>
<figure class="highlight plaintext"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">float2 uv=float2(0.5*(-i.worldPos.x+_PlayerPosition.x)/_SnowRange.x+0.5,</span><br><span class="line">                                 0.5*(-i.worldPos.z+_PlayerPosition.z)/_SnowRange.z+0.5);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样计算得到的uv由于使用了纹理clamp计算，所以超过范围的值会被放到边缘，而边缘大概率是没有轨迹的，所以也是可行的，如果还是产生了这个原因导致的大片错误颜色，可以考虑对这个uv进行特殊判断或者是在cs中把边缘特殊处理，不过都会消耗一点性能。<br>到这一步就完成了一个基础的轨迹效果，这个效果无论和场景的大小和凹凸程度无关，但是在多层的地图上可能会产生bug。 目前的轨迹只是一个简单的白色圆形，雪地shader上的计算也只是把颜色叠加上去，但是利用cs可以实现自定义的纹理形状，甚至是用视差或者法线贴图来实现更真实的效果。</p>
<h1 id="进一步优化代码"><a href="#进一步优化代码" class="headerlink" title="进一步优化代码"></a>进一步优化代码</h1><p><img src="/image/images/games/demo1/gif02.gif" alt="图"></p>
<p>上一节原有的代码显然存在由于精度导致的误差问题，只不过我通过把movement向量中较低的值归为零来避免了移动距离过近的时候产生的明显误差（即使人物在墙角几乎没有动，脚下的轨迹也会移动）。<br>当然，在计算机图形学中，看上去是对的那就是对的，高速移动时远处的轨迹问题反正也看不出来（确信），不过为了精益求精我们还是追求把误差进一步消去。<br>观察误差产生的原因，因为我们使用的RT大小有限，无法把整个移动范围完全细分，而在计算偏移位置的时候算出的数组下标是一个整数，在这个过程中偏移的小数部分被丢失，积累了一定误差之后就会出现某一次的偏移值错误的情况，导致脚下的轨迹进行错误的偏移。<br>在shader中，因为不可能把使用整数下标来采样的纹理变成用小数采样，所以只能考虑把误差转移到其他部分。由于纹理是以角色为中心的，而角色的位置精度必须是尽可能大的，要不然人物的移动就会呈现锯齿的状态了，所以这里最好把误差放在构造出的RenderTexture上。<br>我们知道，在这个跟随玩家的平面某一维度中最小的长度单位应该是：这个平面的长度&#x2F;RenderTexture在这维度上的分辨率，因此我们在C#脚本中把角色的具体位置离散化到最小单位为上述最小长度的网格中，用在这个离散系下的移动距离和位置来计算偏移值、传入shader。</p>
<figure class="highlight c#"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">Vector2 <span class="title">getUnitPosition</span>(<span class="params">Vector3 position</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> x= Mathf.Floor(position.x/xUnit);</span><br><span class="line">    <span class="built_in">float</span> y= Mathf.Floor(position.z/yUnit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Vector2(x, y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Vector3 <span class="title">getWorldUnitPosition</span>(<span class="params">Vector3 position</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> x = Mathf.Floor(position.x / xUnit) * xUnit;</span><br><span class="line">    <span class="built_in">float</span> z = Mathf.Floor(position.z / yUnit)*yUnit;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Vector3(x, position.y, z);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">xUnit = planeScale.x / (texWidth + <span class="number">0.001f</span>);</span><br><span class="line">yUnit = planeScale.y / (texHeight + <span class="number">0.001f</span>);</span><br><span class="line">...</span><br><span class="line">Vector2 nowPosition=getUnitPosition(transform.position);</span><br><span class="line">Vector2 moveVector=nowPosition-formerPosition;</span><br><span class="line">cs.SetVector(<span class="string">&quot;MoveVector&quot;</span>, moveVector);</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样一来，误差只会产生在当RT分辨不够高的时候，脚下产生的脚印和角色位置之间，且误差距离在unit之内，只要在unit够小的的时候就完全感受不出来误差了。<br>其次，标题虽然是“基于ComputeShader的实现方式”，但现在已有的内容其实即使不用ComputeShader，只用blit也可以实现，那么接下来就加入一些ComputeShader内容。<br>在之前的代码中，为了记录纹理中每个位置上脚印出现后的时间，我们开了一张纹理，而这个纹理为了和之前一帧的进行迭代，又附带了一张新的纹理，这两张纹理都只有一个通道是有用的，毫无疑问浪费了很多空间，实际上要存储一个和纹理大小相同的数组根本不需要新开纹理，而是可以使用ComputeBuffer来实现。</p>
<figure class="highlight c#"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">int</span> bufflen = texHeight * texWidth;</span><br><span class="line">Datas = <span class="keyword">new</span> Vector4[bufflen];</span><br><span class="line">LastDatas = <span class="keyword">new</span> Vector4[bufflen];</span><br><span class="line">DataBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">DataBuffer.SetData(Datas);</span><br><span class="line">LastDataBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">LastDataBuffer.SetData(LastDatas);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">targetRT.enableRandomWrite = <span class="literal">true</span>;</span><br><span class="line">targetRT.Create();</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">xUnit = planeScale.x / (texWidth + <span class="number">0.001f</span>);</span><br><span class="line">yUnit = planeScale.y / (texHeight + <span class="number">0.001f</span>);</span><br><span class="line">formerPosition = getUnitPosition(transform.position);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">kl = cs.FindKernel(<span class="string">&quot;CSMain&quot;</span>);</span><br><span class="line">kp = cs.FindKernel(<span class="string">&quot;CSPassData&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cs.SetVector(<span class="string">&quot;ColorSnow&quot;</span>, ColorSnow);</span><br><span class="line"></span><br><span class="line">cs.SetTexture(kl,<span class="string">&quot;Result&quot;</span>,targetRT);</span><br><span class="line">cs.SetTexture(kp, <span class="string">&quot;Result&quot;</span>, targetRT);</span><br><span class="line"></span><br><span class="line">cs.SetBuffer(kl, <span class="string">&quot;DataBuffer&quot;</span>, DataBuffer);</span><br><span class="line">cs.SetBuffer(kl, <span class="string">&quot;LastDataBuffer&quot;</span>, LastDataBuffer);</span><br><span class="line">cs.SetBuffer(kp, <span class="string">&quot;DataBuffer&quot;</span>, DataBuffer);</span><br><span class="line">cs.SetBuffer(kp, <span class="string">&quot;LastDataBuffer&quot;</span>, LastDataBuffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cs.SetVector(<span class="string">&quot;ColorTrail&quot;</span>, ColorTrail);</span><br><span class="line">cs.SetFloat(<span class="string">&quot;Fade&quot;</span>, Fade);</span><br><span class="line">cs.SetFloat(<span class="string">&quot;TrailSize&quot;</span>, TrailSize);</span><br><span class="line">cs.SetFloat(<span class="string">&quot;Width&quot;</span>, (<span class="built_in">float</span>)texWidth);</span><br><span class="line">cs.SetFloat(<span class="string">&quot;Height&quot;</span>, (<span class="built_in">float</span>)texHeight);</span><br><span class="line">cs.SetFloat(<span class="string">&quot;TrailTime&quot;</span>, TrailTime);</span><br><span class="line">cs.SetVector(<span class="string">&quot;Unit&quot;</span>, <span class="keyword">new</span> Vector2(xUnit, yUnit));</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在使用ComputeBuffer代替原来的纹理之后，游戏的全屏延迟其实没有怎么减少（还是3.3ms左右），那是因为这个方法其实并没有减少时间复杂度，仅仅是优化了空间。<br>大家可能已经发现，实际上最后雪地shader上的计算仅靠c#脚本传入的玩家位置和判定范围来完成，跟随玩家的那个平面并没有实际作用，只是用来界定大小的工具，因此我们也可以仅用一个Vector2来代替它，避免一个平面带来的性能消耗和不必要的问题。 到此为止效果的第一步就完成了，当然，可以用其它的计算方法让轨迹和形状更美观、轨迹的消失更加丝滑，不过现在这个轨迹效果已经可以接受。</p>
<h1 id="轨迹形状制作-法线"><a href="#轨迹形状制作-法线" class="headerlink" title="轨迹形状制作-法线"></a>轨迹形状制作-法线</h1><p><img src="/image/images/games/demo1/image12.png" alt="图"><br>简单用法线捏的一个效果，可以看出来不是很理想，有很多锯齿。<br><img src="/image/images/games/demo1/image15.png" alt="图"><br>用个小trick稍微减少了锯齿。</p>
<p>在前两步中完成了一个简单的轨迹效果，但是现在的轨迹只是一片纯色，看起来不像是真的轨迹，可以考虑使用一些方法来让它变成真正的轨迹，这里先采用一个相对简单的直接计算法线的方法来完成。<br>假定现在有一个圆形的坑，它的横截面看起来像是一个y&#x3D;x^6的函数曲线，坑的底部是(0,0)，边缘是(1,1)和(-1,1)，那么我们可以通过求导的方法来求出法线，把三维空间看成是由无数个与水平面垂直的平面组成的，每个平面都是上述的函数，那么我们只需要知道这个平面的基向量和曲线中的x，就能算出一个位置的法线。<br>这么一来，在ComputeBuffer中需要存储的值就定为了：1.点的水平面方向向量，2.点距离自己的圆坑中心的距离，3.点当前的“时间”（在上一节中说明）。<br>而这些属性和第二节中的透明度一样，需要用时间来插值计算出来，因此我们还需要一个参考值来进行插值运算来完成衰减效果，分别对应时间的0和1（1是刚被踩过的时间点，0是没有被踩过的时间点），对于向量来讲，这个参考值显然就是自己的(0,0)和自己未被衰减时的向量值，因为对于一个没有被踩过的点，它的法线水平分量显然是（0,0）。<br>而对于离圆坑中心的距离，参考值则是1和未被衰减时的距离，法线由当前值来计算得到，记得对法线进行pack，否则会因为纹理无法储存小于0的浮点值而产生错误。</p>
<figure class="highlight plaintext"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">float2 center=float2(Width/2,Height/2);</span><br><span class="line">float dis=LengthAbs(center,id.xy);</span><br><span class="line">float2 direction=DataBuffer[index2].xy;</span><br><span class="line">float xpos=lerp(1,DataBuffer[index2].w,clamp(DataBuffer[index2].z*TrailTime,0,1));</span><br><span class="line">if(dis&lt;TrailSize)&#123;</span><br><span class="line">	float inpos=dis/TrailSize;</span><br><span class="line">	float height=PowHeight(inpos);</span><br><span class="line">	if(height&lt;=PowHeight(xpos))&#123;</span><br><span class="line">		xpos=inpos;</span><br><span class="line">		direction=normalize(float2(id.x-center.x,id.y-center.y));</span><br><span class="line">		DataBuffer[index2]=float4(direction,1,xpos);</span><br><span class="line">	&#125;</span><br><span class="line">	DataBuffer[index2].z=1;</span><br><span class="line">&#125;</span><br><span class="line">float2 realDirection=lerp(float2(0,0),direction,clamp(DataBuffer[index2].z*TrailTime,0,1));</span><br></pre></td></tr></table></figure>
<p>在C#脚本里设置相关的变量关联和内存释放，然后在shader中把原先采样RT叠加颜色的方法改成采样RT得到并unpack法线，就完成了这次的效果。 然后是图中出现的锯齿问题，显然，锯齿的产生源于之前把地图离散化造成的采样率不足，使得对法线的采样率远低于了屏幕显示出的采样率，因此相邻的两个圆坑之间出现了锯齿效果。<br><img src="/image/images/games/demo1/image14.png" alt="图"><br>要解决这个问题，第一种想法：我们降低生成图形的精度（低通滤波），即对于整张法线贴图进行模糊，显然这个做法会消耗很多性能，而且效果并不好，至少我们希望在近处看自己踩出来的轨迹边缘是比较锐利的。<br>第二种想法：我们提升采样率，这个方法带来的代价更加的高，而且也无法彻底消除误差。<br>第三种想法：解决不了问题就解决产生问题的人，我们不使用这种圆坑形轨迹，而是使用一个超过这个采样率也没什么问题的轨迹，比如说一个底面更为平坦的“圆梯形”，这个图形很容易得到，只要把原来的圆坑进行一些特殊处理就行了。<br>这次选用的函数是y&#x3D;max(0,6x^6-5)，它同样具有原本的性质，只不过底面更加的扁平，它的导数在零点左边是0，在零点右边是36x^6。<br><img src="/image/images/games/demo1/image15.png" alt="图"><br>可以看出来其实还是有细小的噪点，而且坑位变浅了，这是因为这个函数的变化率太高了，一小片区域的法线并不能达到足够的视差效果，相信可以捏出一个更适合表现效果的函数，这里就不多试了。<br>不过更大的问题也确实存在：新的轨迹覆盖原有的轨迹，这个问题导致了边缘的法线被覆盖之后错误的计算，这个问题在当前的数据资源下是无法解决的，它的来源是因为法线计算在这个问题中其实并不合适。<br>为什么这么说呢？一是法线的计算需要知道某点位于圆坑的哪个位置，而实际上这个位置并不是唯一的，而是根据四周的地形高度来进行变化的，二是因为法线在圆坑的边缘是水平方向，而在圆坑外却是竖直方向，这个突跃处法线用时间来插值没有实际意义，此外，纯数据计算虽然非常直观且方便调整，但它最大的坏处是缺失细节。<br>而更能胜任这个工作的方法很显然：直接算出某点在某处的高度，使用位移贴图的方法。</p>
<h1 id="曲面细分真香"><a href="#曲面细分真香" class="headerlink" title="曲面细分真香"></a>曲面细分真香</h1><p><img src="/image/images/games/demo1/gif03.gif" alt="图"><br>姑且像点样子了。</p>
<p>上回说到因为法线贴图存在一个非线性突变的原因，光用法线来实现效果会出现很多问题，真正完全没有问题的方法是用高度去计算，选用位移贴图的方法，配合上曲面细分着色器让表面真的下降。当然，使用曲面细分会降低一定的兼容性（反正都用ComputeShader了），不过实现的效果无可挑剔。<br>使用位移贴图计算的话，第三节中需要储存的“点到圆坑的方向向量”就不需要用到了，只需要存高度和时间就可以了，ComputeShader的计算套路和之前一样，存储一个在“刚被踩下”时刻的高度，然后根据时间的插值公式来算出当前时间点实际的高度，把实际的高度写入RT。<br>而曲面细分着色器的编写在各大教程中都有提到，如果需要的话可以查看后面的代码链接（我自己的也是抄的），曲面细分的大小决定了效果的精细程度，如果细分过低的话可能会导致边缘处模型碎裂的情况。<br>此外，在上节的代码中会出现一个因为脚印半径过大导致走到墙边的时候墙上出现脚印的情况，在这节中把计算用的数据量替换为高度之后，我们可以通过判断高度来轻松完成判断来修正这种效果。</p>
<figure class="highlight plaintext"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(o.worldPos.y&lt;=_PlayerPosition.y&amp;&amp;_PlayerPosition.y&lt;=o.worldPos.y+3)o.worldPos.y-=height;</span><br></pre></td></tr></table></figure>
<p>当然，更简单的方法是永远不要让脚印的范围出现在墙上。</p>
<h1 id="自定义置换贴图、附加法线"><a href="#自定义置换贴图、附加法线" class="headerlink" title="自定义置换贴图、附加法线"></a>自定义置换贴图、附加法线</h1><p><img src="/image/images/games/demo1/gif04.gif" alt="图"><br>（然而其实并没有做法线，还是很丑233） 在完成4的基础上，进一步美化效果，用一张带信息的纹理来储存高度，从而可以完成gif中这样有高有低的效果，而不是单纯的一个圆形，采样的方法只是把原来基于距离计算的高度改成了按照uv进行采样。<br>个人并没有使用非圆形的效果，所以不用根据玩家的面向来调整uv采样的方式，算是比较水的完成了这个效果。</p>
<figure class="highlight plaintext"><figcaption><span>代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if(dis&lt;TrailSize)&#123;</span><br><span class="line">    float2 uv=0.5*((id.xy-center)/TrailSize)+0.5;</span><br><span class="line">    float inpos=dis/TrailSize;</span><br><span class="line">    float4 samp=Displacement[uv*float2(DisWidth,DisHeight)];</span><br><span class="line">    float h=samp.x-1+samp.y*0.3;</span><br><span class="line">    float height=min(h,nowheight);</span><br><span class="line">    if(h&gt;=0&amp;&amp;nowheight&gt;=0)</span><br><span class="line">        height=h;</span><br><span class="line">    DataBuffer[index2].y=1;</span><br><span class="line">    nowheight=height;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>附加法线可以用同样的方法对一个法线贴图进行采样，但是法线也要加入按时间衰减的代码，否则会出现不正常的锐利效果。法线的三个维度和高度的一个维度刚好可以压缩进一个纹理里。</p>
<h1 id="其他重要优化"><a href="#其他重要优化" class="headerlink" title="其他重要优化"></a>其他重要优化</h1><p>1.曲面细分优化：曲面细分固然是越高效果越好的，然而对性能也是非常大的考验，大地图进行高精度的曲面细分非常的浪费，实际上在玩家踩不出坑的范围内曲面细分就已经没有意义了，因此在雪面shader中可以加入代码来判断当前的位置是否需要进行细分，只细分离玩家近的区域。<br>代码非常的简单，只要在曲面细分函数里判断一下玩家位置到当前顶点的距离即可，和原先判断踩痕的算法没有任何区别。</p>
<p><img src="/image/images/games/demo1/image18.png" alt="图"><br>2.多单位优化：在这个做法里显然加入多单位就意味着成倍的运算量，这并不合适，这里我们可以使用前向渲染的类似规则——只考虑离自己最近的几个单位，当然这样一来在面对茫茫大军的时候就容易穿帮了。<br>3.有间隔的轨迹（脚印）：实际上这个做起来反而更加简单，因为轨迹出现的频率低了，采样率反而足够了，想怎么采怎么采。<br>4.更优雅地消失：现实生活中雪的恢复肯定不是像我做的这样跟衔尾蛇一样移动的，它们消失的时间和被踩出来的时间有时候并不成正比，具体优化的方法想必就见仁见智了233。<br>5.让轨迹更加平滑：在上一步中我们已经引入了法线贴图来制作更优秀的细节，但是法线制作的细节同样会带来问题：我们在compute shader的计算中，是靠高度来决定是否对一个点的高度和法线进行替换的，这对于高度固然没问题，但是如果想要实现完美的法线效果的话，就会发现在最低高度的一部分区域法线也是有倾斜度的。<br>这样的倾斜度使得运动起来的时候由于采样率的原因（没错，还是这个原因），会留下一片错误的法线，使之前的锯齿效果卷土重来。<br>想了三个解决方法：<br>1.继续套娃：在高度纹理当中，我们还有b和w两个通道没有使用，我们可以用这个通道来储存一个新的参量,决定当前的位置是否会覆盖原有的高度和法线，当然，这个参量的真值存在于法线贴图里正中间没有法线的那片区域，但这个做法并不巧妙，而且依然会面对采样率问题，并不自由。<br>2.万能模糊：采样率引起的问题就用低通滤波解决，把中间那片法线直接给模糊掉，但是，这里做的实际上并不是真正的模糊，而是有一个小trick：我们实际上只需要剔除掉踩出的道路中间的那部分法线就能完成效果，而怎么决定一个顶点是否在道路中间呢？只要取样这个像素点四个不同方向的点，如果四个点的高度全都是-1，也就是坑底，那这个点也在坑底，如果是在坑边缘的话，四个点里至少有一个点会出现在坑的上面。<br>3.暴力切除：反正我要的只是光滑的轨迹，那就只要把高度为-1左右的点法线全部朝上就行了，这个做法不仅省时间省空间，还省脑子，唯一的缺点是会存在在-1高度左右的一个突跃点，但是别有一番风味（bushi）。<br>在套娃和模糊的间隙，我选择了脑子，所以在最终图里现在大家看到的是第三种做法的结果。</p>
<h1 id="加入美术效果"><a href="#加入美术效果" class="headerlink" title="加入美术效果"></a>加入美术效果</h1><p><img src="/image/images/games/demo1/gif05.gif" alt="图"></p>
<p>现在要开始加速了！<br>既然初衷是雪山赛车，并且使用了一个精度比较高的算法，我把游戏的主角换成了迫真的车（虽然并不是赛车），把场景换成了迫真的雪山（模型网白嫖的），然后给雪山加上了魔改后的pbr，让它带有一点最初的氛围，为了营造雪山飙车这种紧张刺激的氛围，我选择了一个线条起伏比较大的模型。</p>
<p><img src="/image/images/games/demo1/image21.png" alt="图"></p>
<p>接下来，缺什么显而易见——雪和雾，这两个是雪山不可缺少的东西，可以说没有雪和雾就没有雪山。<br>雾使用了自己魔改的一块深度雾，增强了雾的颗粒感并压暗了亮度，同样是为了营造紧张刺激的感觉，雪用了一块跟随自己的粒子系统。<br>在这么黑暗的环境里开车，没有灯光怎么行，但是再做体积光的话性能估计受不了，于是在烘焙光和点光之间选择了点光。<br>但是这样改完总觉得还是缺少了什么，一顿思索之后发现……是运动模糊和径向模糊，这两个是赛车不可缺少的东西，可以说没有运动模糊和径向模糊就没有赛车。<br>这两个都是非常好写的后处理效果，这里就不再多提。</p>
<p><img src="/image/images/games/demo1/image22.png" alt="图"></p>
<p>一通调参之后，就形成了最终的效果，完结撒花~</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight plaintext"><figcaption><span>ComputeShader代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// Each #kernel tells which function to compile; you can have many kernels</span><br><span class="line">#pragma kernel CSMain</span><br><span class="line">#pragma kernel CSPassData</span><br><span class="line">// Create a RenderTexture with enableRandomWrite flag and set it</span><br><span class="line">// with cs.SetTexture</span><br><span class="line">RWTexture2D&lt;float4&gt; Result;</span><br><span class="line">RWTexture2D&lt;float4&gt; Displacement;</span><br><span class="line">RWTexture2D&lt;float4&gt; Normal;</span><br><span class="line">RWStructuredBuffer&lt;float4&gt; DataBuffer;</span><br><span class="line">RWStructuredBuffer&lt;float4&gt; LastDataBuffer;</span><br><span class="line">RWStructuredBuffer&lt;float&gt; TimeBuffer;</span><br><span class="line">RWStructuredBuffer&lt;float&gt; LastTimeBuffer;</span><br><span class="line">float Width;</span><br><span class="line">float Height;</span><br><span class="line">float4 ColorSnow;</span><br><span class="line">float4 ColorTrail;</span><br><span class="line">float4 MoveVector;</span><br><span class="line">float2 FaceDirection;</span><br><span class="line">float Fade;</span><br><span class="line">float TrailSize;</span><br><span class="line">float TrailTime;</span><br><span class="line">float2 Unit;</span><br><span class="line">int DisWidth;</span><br><span class="line">int DisHeight;</span><br><span class="line"></span><br><span class="line">float LengthAbs(float2 x,float2 y)&#123;</span><br><span class="line">    </span><br><span class="line">    float2 dif=x-y;</span><br><span class="line">    return sqrt(dot(dif,dif));</span><br><span class="line">&#125;</span><br><span class="line">float rand(float3 x)&#123;</span><br><span class="line">                return frac(sin(dot(x.xyz,float3(12.9898,78.233,53.539)))*43758.5453);</span><br><span class="line">            &#125;</span><br><span class="line">[numthreads(16,16,2)]</span><br><span class="line">void CSMain (uint3 id : SV_DispatchThreadID)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    //get last data and pass it</span><br><span class="line">    int index1=clamp(id.y*Width-(int)MoveVector.y*Width+id.x-(int)MoveVector.x,0,Width*Height-1);</span><br><span class="line">    int index2=id.y*Width+id.x;</span><br><span class="line">    // x,y for direction, z for time ,w for xPos</span><br><span class="line">    DataBuffer[index2]=LastDataBuffer[index1];</span><br><span class="line">    TimeBuffer[index2]=LastTimeBuffer[index1];</span><br><span class="line">    TimeBuffer[index2]=max(0,TimeBuffer[index2]-Fade/100);</span><br><span class="line">    float time=pow(min(TrailTime,TimeBuffer[index2])/TrailTime,5);</span><br><span class="line">    float nowheight=lerp(0,DataBuffer[index2].w,time);</span><br><span class="line">    float3 nownormal=lerp(float3(0,1,0),DataBuffer[index2].xyz,time);</span><br><span class="line">    //figure out direction and distance</span><br><span class="line">    float2 center=float2(Width/2,Height/2);</span><br><span class="line">    float dis=LengthAbs(id.xy,center);</span><br><span class="line"></span><br><span class="line">    //update the new print</span><br><span class="line">    if(dis&lt;TrailSize)&#123;</span><br><span class="line">        float2 uv=(id.xy-center)/TrailSize;</span><br><span class="line">        float2 bd=normalize(FaceDirection);</span><br><span class="line">        float2x2 rot=float2x2(0,1,-1,0);</span><br><span class="line">        float2 ac=mul(rot,bd);</span><br><span class="line">        float dv=ac.x*bd.y-bd.x*ac.y;</span><br><span class="line">        float2x2 mtx=float2x2(bd.y/dv,-ac.y/dv,-bd.x/dv,ac.x/dv);</span><br><span class="line">        uv=mul(mtx,uv);</span><br><span class="line"></span><br><span class="line">        uv=(uv*0.5+0.5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        float4 sampDis=Displacement[uv*float2(DisWidth,DisHeight)];</span><br><span class="line">        //float3 sampNormal=-Normal[uv*float2(DisWidth,DisHeight)].xyz;</span><br><span class="line">       // sampNormal.y*=-1;</span><br><span class="line">       float3 sampNormal=Normal[uv*float2(DisWidth,DisHeight)].xyz;</span><br><span class="line">        float h=sampDis.x-1+sampDis.y*0.1;</span><br><span class="line">        float height=min(h,nowheight);</span><br><span class="line">        sampNormal+=0.1*rand(sampNormal);</span><br><span class="line">        if(h&lt;nowheight||h&gt;=0&amp;&amp;nowheight&gt;=0)&#123;</span><br><span class="line">            height=h;</span><br><span class="line">           nownormal=sampNormal;</span><br><span class="line">        &#125;</span><br><span class="line">        if(sampDis.x&lt;0.01&amp;&amp;sampDis.z==1)</span><br><span class="line">            nownormal=sampNormal;</span><br><span class="line">        TimeBuffer[index2]=1;</span><br><span class="line">        nowheight=height;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    DataBuffer[index2].w=nowheight;</span><br><span class="line">    DataBuffer[index2].xyz=nownormal;</span><br><span class="line">    //update Result</span><br><span class="line">    Result[id.xy]=float4(DataBuffer[index2].xyz, nowheight*0.5+0.5);</span><br><span class="line">   // Result[id.xy]=Displacement[id.xy/float2(Width,Height)*float2(DisWidth,DisHeight)];</span><br><span class="line">   // Result[id.xy]=float4(UV,0,1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[numthreads(16,32,2)]</span><br><span class="line">void CSPassData (uint3 id : SV_DispatchThreadID)</span><br><span class="line">&#123;</span><br><span class="line">    int index=id.y*Width+id.x;</span><br><span class="line">    LastDataBuffer[index]=DataBuffer[index];</span><br><span class="line">    LastTimeBuffer[index]=TimeBuffer[index];</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>Shader代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Shader &quot;Snowy/SnowyGround</span><br><span class="line">&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _BaseMap (&quot;Texture&quot;, 2D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">        _NormalMap(&quot;NormalMap&quot;,2D)=&quot;white&quot;&#123;&#125;</span><br><span class="line">        _RT(&quot;RT&quot;,2D)=&quot;white&quot;&#123;&#125;</span><br><span class="line"></span><br><span class="line">        _Roughness(&quot;Roughness&quot;,Range(0,5))=0.56</span><br><span class="line">        _Metallic(&quot;Metallic&quot;,Range(0,2))=0.412</span><br><span class="line">        _BumpScale(&quot;Bump Scale&quot;,Range(0,3))=1</span><br><span class="line"></span><br><span class="line">        _Gloss(&quot;Gloss&quot;,Range(1,20))=5</span><br><span class="line">        _SpecularColor(&quot;SpecularColor&quot;,Color)=(1,1,1,1)</span><br><span class="line">        _BumpScale(&quot;Bump Scale&quot;,Range(1,10))=1.0</span><br><span class="line">        _PlayerPosition(&quot;Player Position&quot;,Vector)=(1,1,1,1)</span><br><span class="line">        _SnowRange(&quot;Snow Range&quot;,Vector)=(1,1,1,1)</span><br><span class="line">        _TessellationUniform(&quot;TessellationUniform&quot;,Range(1,128))=10</span><br><span class="line">        _DisplacementScale(&quot;DisplacementScale&quot;,Range(0,10))=1</span><br><span class="line">        _TrailColor(&quot;Trail Color&quot;,Color)=(1,1,1,1)</span><br><span class="line">        _TrailRange(&quot;Trail Range&quot;,Range(1,40))=7</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot;</span><br><span class="line">                &quot;Queue&quot;=&quot;Geometry&quot;&#125;</span><br><span class="line">        LOD 200</span><br><span class="line">        HLSLINCLUDE</span><br><span class="line">        </span><br><span class="line">            #include &quot;PBR.hlsl&quot;</span><br><span class="line">            struct appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                float4 normal:NORMAL;</span><br><span class="line">                float4 tangent:TANGENT;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2h</span><br><span class="line">            &#123;              </span><br><span class="line">                float4 vertex : INTERNALTESSPOS;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                float4 normal:NORMAL;</span><br><span class="line">                float4 tangent:TANGENT;</span><br><span class="line">                </span><br><span class="line">            &#125;;</span><br><span class="line">            struct t2f</span><br><span class="line">            &#123;              </span><br><span class="line">                float4 positionCS : SV_POSITION;</span><br><span class="line">                float4 uv : TEXCOORD0;</span><br><span class="line">                float4 normalWS : TEXCOORD1; </span><br><span class="line">                float4 tangentWS : TEXCOORD2; </span><br><span class="line">                float4 bitangentWS : TEXCOORD3;</span><br><span class="line">                float4 positionWS:TEXCOORD4;</span><br><span class="line">                float colorBuff:TEXCOORD5;</span><br><span class="line">                float3 bumpAdd:TEXCOORD6;</span><br><span class="line">                </span><br><span class="line">            &#125;;</span><br><span class="line">        //    CBUFFER_START(UnityPerMaterial)</span><br><span class="line">        //    TEXTURE2D(_BaseMap); SAMPLER(sampler_BaseMap);</span><br><span class="line">            TEXTURE2D(_NormalMap); SAMPLER(sampler_NormalMap);</span><br><span class="line">        //    CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            </span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">           // float4 _BaseMap_ST;</span><br><span class="line">            float _Roughness;</span><br><span class="line">         //   float _Metallic;</span><br><span class="line">         //   float _BumpScale;</span><br><span class="line">       //     CBUFFER_END</span><br><span class="line">            sampler2D _RT;</span><br><span class="line">            float _Gloss;</span><br><span class="line">            float4 _SpecularColor;</span><br><span class="line">            float4 _PlayerPosition;</span><br><span class="line">            float4 _SnowRange;</span><br><span class="line">            float4 _TrailColor;</span><br><span class="line">            float _DisplacementScale;</span><br><span class="line">            float _TrailRange;</span><br><span class="line">      //      CBUFFER_END</span><br><span class="line"></span><br><span class="line">            v2h vert (appdata v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2h o;</span><br><span class="line">                o.vertex=v.vertex;</span><br><span class="line">                o.uv=v.uv;</span><br><span class="line">                o.normal=v.normal;</span><br><span class="line">                o.tangent=v.tangent;</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">     //#ifdef UNITY_CAN_COMPILE_TESSELLATION</span><br><span class="line"></span><br><span class="line">            struct OutputPatchConstant&#123;</span><br><span class="line">                float edge[3]:SV_TessFactor;</span><br><span class="line">                float inside:SV_InsideTessFactor;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            float _TessellationUniform;</span><br><span class="line">            OutputPatchConstant hsconst (InputPatch&lt;v2h,3&gt; patch)&#123;</span><br><span class="line">                OutputPatchConstant o;</span><br><span class="line">                o.edge[0]=1;</span><br><span class="line">                o.edge[1]=1;</span><br><span class="line">                o.edge[2]=1;</span><br><span class="line">                o.inside=1;</span><br><span class="line">                if(distance(mul(UNITY_MATRIX_M,patch[0].vertex).xz,_PlayerPosition.xz)&lt;=_TrailRange)&#123;</span><br><span class="line">                o.edge[0] = _TessellationUniform;</span><br><span class="line">                o.edge[1] = _TessellationUniform;</span><br><span class="line">                o.edge[2] = _TessellationUniform;</span><br><span class="line">                o.inside  = _TessellationUniform;</span><br><span class="line">                &#125;</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            [domain(&quot;tri&quot;)]//ȷ��ͼԪ��quad,triangle��</span><br><span class="line">            [partitioning(&quot;fractional_odd&quot;)]//���edge�Ĺ���equal_spacing,fractional_odd,fractional_even</span><br><span class="line">            [outputtopology(&quot;triangle_cw&quot;)]</span><br><span class="line">            [patchconstantfunc(&quot;hsconst&quot;)]//һ��patchһ���������㣬�����������㶼�����������</span><br><span class="line">            [outputcontrolpoints(3)]      //��ͬ��ͼԪ���Ӧ��ͬ�Ŀ��Ƶ�</span><br><span class="line">            v2h hullProgram (InputPatch&lt;v2h,3&gt; patch,uint id : SV_OutputControlPointID)&#123;</span><br><span class="line">                //����hullshaderV����</span><br><span class="line">                return patch[id];</span><br><span class="line">            &#125;</span><br><span class="line">            t2f dvert(v2h i)&#123;</span><br><span class="line">                t2f o;</span><br><span class="line">	            float3 positionWS = TransformObjectToWorld(i.vertex.xyz);</span><br><span class="line">                o.positionWS=float4(positionWS,1);</span><br><span class="line">	            o.uv.xy = TRANSFORM_TEX(i.uv, _BaseMap);</span><br><span class="line">	            o.normalWS.xyz = normalize(TransformObjectToWorldNormal(i.normal.xyz));</span><br><span class="line">	            o.tangentWS.xyz = normalize(TransformObjectToWorldDir(i.tangent.xyz));</span><br><span class="line">	            o.bitangentWS.xyz = cross(o.normalWS.xyz, o.tangentWS.xyz) * i.tangent.w * unity_WorldTransformParams.w;</span><br><span class="line">	            o.normalWS.w = positionWS.x;</span><br><span class="line">	            o.tangentWS.w = positionWS.y;</span><br><span class="line">	            o.bitangentWS.w = positionWS.z;</span><br><span class="line">                float2 uv=float2(0.5*(-o.positionWS.x+_PlayerPosition.x)/_SnowRange.x+0.5,</span><br><span class="line">                                 0.5*(-o.positionWS.z+_PlayerPosition.z)/_SnowRange.z+0.5);</span><br><span class="line">                float height=(tex2Dlod(_RT,float4(uv,0,0)).w*2-1);</span><br><span class="line">             //   if(uv.x&gt;=0&amp;&amp;uv.x&lt;=1&amp;&amp;uv.y&gt;=0&amp;&amp;uv.y&lt;=1)o.normalWS=tex2Dlod(_RT,float4(uv,0,0)).xyz*2-1;</span><br><span class="line">                //if(height&gt;=0.01||height&lt;=-0.01)o.normalWS=tex2Dlod(_RT,float4(uv,0,0)).xyz*2-1;</span><br><span class="line">                o.bumpAdd=float3(0,1,0);</span><br><span class="line">                o.colorBuff=0;</span><br><span class="line">                if(height&gt;-0.99&amp;&amp;abs(height)&gt;0.1)&#123;</span><br><span class="line">                    o.bumpAdd=tex2Dlod(_RT,float4(uv,0,0)).xyz*2-1;</span><br><span class="line">                    o.colorBuff=1;</span><br><span class="line">                &#125;</span><br><span class="line">                //if(o.worldPos.y&lt;=_PlayerPosition.y&amp;&amp;_PlayerPosition.y&lt;=o.worldPos.y+3)o.worldPos.y+=height;</span><br><span class="line">                //float sampleDis=0.2;</span><br><span class="line">                //float h1=(tex2Dlod(_RT,float4(uv+float2(sampleDis,0),0,0)).w*2-1);</span><br><span class="line">                //float h2=(tex2Dlod(_RT,float4(uv+float2(-sampleDis,0),0,0)).w*2-1);</span><br><span class="line">                //float h3=(tex2Dlod(_RT,float4(uv+float2(0,sampleDis),0,0)).w*2-1);</span><br><span class="line">                //float h4=(tex2Dlod(_RT,float4(uv+float2(0,-sampleDis),0,0)).w*2-1);</span><br><span class="line">                //if(h1&lt;0&amp;&amp;h2&lt;0&amp;&amp;h3&lt;0&amp;&amp;h4&lt;0)o.bumpAdd=float3(0,1,0);</span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">                o.positionWS.y+=height*_DisplacementScale;</span><br><span class="line">                </span><br><span class="line">	            o.positionCS = TransformWorldToHClip(o.positionWS);</span><br><span class="line">                return o;</span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">            [domain(&quot;tri&quot;)]//ͬ����Ҫ����ͼԪ</span><br><span class="line">            t2f ds (OutputPatchConstant tessFactors, const OutputPatch&lt;v2h,3&gt;patch,float3 bary :SV_DOMAINLOCATION)</span><br><span class="line">            //bary:��������</span><br><span class="line">            &#123;</span><br><span class="line">                v2h v;</span><br><span class="line">                v.vertex = patch[0].vertex*bary.x + patch[1].vertex*bary.y + patch[2].vertex*bary.z;</span><br><span class="line">			    v.tangent = patch[0].tangent*bary.x + patch[1].tangent*bary.y + patch[2].tangent*bary.z;</span><br><span class="line">			    v.normal = patch[0].normal*bary.x + patch[1].normal*bary.y + patch[2].normal*bary.z;</span><br><span class="line">			    v.uv = patch[0].uv*bary.x + patch[1].uv*bary.y + patch[2].uv*bary.z;</span><br><span class="line"></span><br><span class="line">                t2f o = dvert (v);</span><br><span class="line"></span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">   </span><br><span class="line">        ENDHLSL</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">         Tags&#123;</span><br><span class="line">                &quot;LightMode&quot;=&quot;UniversalForward&quot;</span><br><span class="line">            &#125;</span><br><span class="line">           // Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            #pragma hull hullProgram</span><br><span class="line">            #pragma domain ds</span><br><span class="line">            #pragma multi_compile _ _MAIN_LIGHT_SHADOWS _MAIN_LIGHT_SHADOWS_CASCADE _MAIN_LIGHT_SHADOWS_SCREEN</span><br><span class="line">            #pragma multi_compile _ _SHADOWS_SOFT</span><br><span class="line">            // make fog work</span><br><span class="line"></span><br><span class="line">            float4 frag (t2f i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                float4 SHADOW_COORDS=TransformWorldToShadowCoord(i.positionWS);</span><br><span class="line">                float shadow=MainLightRealtimeShadow(SHADOW_COORDS);</span><br><span class="line"></span><br><span class="line">                float3 viewDir=SafeNormalize(GetCameraPositionWS()-i.positionWS);</span><br><span class="line">                float3 bump=UnpackNormalScale(SAMPLE_TEXTURE2D(_NormalMap,sampler_NormalMap,i.uv.xy),_BumpScale);</span><br><span class="line">                if(i.colorBuff&gt;0.02)bump=i.bumpAdd;</span><br><span class="line">                float4 col=SAMPLE_TEXTURE2D(_BaseMap,sampler_BaseMap,i.uv.xy);</span><br><span class="line">                bump=mul(bump,real3x3(i.tangentWS.xyz,i.bitangentWS.xyz,i.normalWS.xyz));</span><br><span class="line">                Light mainLight=GetMainLight();</span><br><span class="line">                float4 lightColor=float4(mainLight.color,1.0);</span><br><span class="line">                float3 lightDir=normalize(mainLight.direction);</span><br><span class="line">                float3 outcolor=0;</span><br><span class="line">          //  #ifdef _AdditionalLights</span><br><span class="line">                int pixelLightCount=GetAdditionalLightsCount();</span><br><span class="line">                for(int ind=0;ind&lt;pixelLightCount;ind++)&#123;</span><br><span class="line">                    Light light=GetAdditionalLight(ind,i.positionWS);</span><br><span class="line">                    float3 ilightColor=light.color*(light.distanceAttenuation*light.shadowAttenuation);</span><br><span class="line">                    PBR_result ip=PBR_Sp(col.xyz,_Metallic,_Roughness,bump,viewDir,normalize(light.direction),ilightColor);</span><br><span class="line">                    outcolor+=ip.spe+ip.dif;</span><br><span class="line">                  //  return float4(viewDir,1);</span><br><span class="line">                    //float NdotL=saturate(dot(i.normalWS,light.direction));</span><br><span class="line">                    //float3 ldif=light.color*((light.distanceAttenuation*light.shadowAttenuation)*NdotL)*col.rgb;</span><br><span class="line">                    //float3 halfDir=normalize(light.direction+viewDir);</span><br><span class="line">                    //float3 lspe=pow(saturate(dot(i.normalWS,halfDir)),15)*light.color*float3(0.8,0.8,0.8);</span><br><span class="line">                    //outcolor+=ldif+lspe;</span><br><span class="line">                &#125;</span><br><span class="line">         //  #endif</span><br><span class="line">             //   return float4(col.xyz,1);</span><br><span class="line">                PBR_result p=PBR_Sp(col.xyz,_Metallic,_Roughness,bump,viewDir,lightDir,lightColor.xyz);</span><br><span class="line">                outcolor+=p.spe+p.dif;</span><br><span class="line">                //col=ambient+diffuse;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                return float4(outcolor*shadow,1);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            //ColorMask 0</span><br><span class="line">            Name &quot;DepthNormals&quot;</span><br><span class="line">            Tags&#123;&quot;LightMode&quot; = &quot;DepthNormals&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">            Stencil&#123;</span><br><span class="line">                Ref [_StencilID]</span><br><span class="line">                Comp [_SComp]</span><br><span class="line">                Pass [_SOp]</span><br><span class="line">            &#125;</span><br><span class="line">            ZWrite On</span><br><span class="line">            Cull Back</span><br><span class="line"></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma exclude_renderers gles gles3 glcore</span><br><span class="line">            #pragma target 4.5</span><br><span class="line"></span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment DepthNormalsFragment</span><br><span class="line">            #pragma hull hullProgram</span><br><span class="line">            #pragma domain dds</span><br><span class="line">                        </span><br><span class="line">         </span><br><span class="line">            Attributes tr(v2h input)&#123;</span><br><span class="line">                Attributes o;</span><br><span class="line">                o.texcoord=input.uv;</span><br><span class="line">                o.positionOS=input.vertex;</span><br><span class="line">                o.tangentOS=input.tangent;</span><br><span class="line">                o.normal=input.normal;</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">            [domain(&quot;tri&quot;)]//ͬ����Ҫ����ͼԪ</span><br><span class="line">            Varyings dds (OutputPatchConstant tessFactors, const OutputPatch&lt;v2h,3&gt;patch,float3 bary :SV_DOMAINLOCATION)</span><br><span class="line">            //bary:��������</span><br><span class="line">            &#123;</span><br><span class="line">                v2h v;</span><br><span class="line">                v.vertex = patch[0].vertex*bary.x + patch[1].vertex*bary.y + patch[2].vertex*bary.z;</span><br><span class="line">			    v.tangent = patch[0].tangent*bary.x + patch[1].tangent*bary.y + patch[2].tangent*bary.z;</span><br><span class="line">			    v.normal = patch[0].normal*bary.x + patch[1].normal*bary.y + patch[2].normal*bary.z;</span><br><span class="line">			    v.uv = patch[0].uv*bary.x + patch[1].uv*bary.y + patch[2].uv*bary.z;</span><br><span class="line"></span><br><span class="line">                Varyings o = DepthNormalsVertex(tr(v));</span><br><span class="line"></span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><figcaption><span>C#脚本代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SnowScript</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Parameter&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2 planeScale;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> texWidth = <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> texHeight= <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> Color ColorSnow;</span><br><span class="line">    <span class="keyword">public</span> Color ColorTrail;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Fade;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> TrailSize;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> TrailTime = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">public</span> ComputeShader cs;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> xUnit;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> yUnit;</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;RenderTextures&amp;Materials&amp;Arrays&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> RenderTexture targetRT;</span><br><span class="line">    <span class="keyword">public</span> Texture2D Displacement;</span><br><span class="line">    <span class="keyword">public</span> Texture2D Normal;</span><br><span class="line">    RenderTexture DisplacementRT;</span><br><span class="line">    RenderTexture NormalRT;</span><br><span class="line">    <span class="keyword">public</span> Material snowLandMaterial;</span><br><span class="line">    <span class="keyword">public</span> Material snowLandGeoMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector4[] Datas;</span><br><span class="line">    <span class="keyword">private</span> Vector4[] LastDatas;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span>[] Time;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span>[] LastTime;</span><br><span class="line">    <span class="keyword">private</span> ComputeBuffer DataBuffer;</span><br><span class="line">    <span class="keyword">private</span> ComputeBuffer LastDataBuffer;</span><br><span class="line">    <span class="keyword">private</span> ComputeBuffer TimeBuffer;</span><br><span class="line">    <span class="keyword">private</span> ComputeBuffer LastTimeBuffer;</span><br><span class="line">    Vector2 formerPosition;</span><br><span class="line">    <span class="built_in">int</span> kl,kp;</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Debug&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject debugOriginal;</span><br><span class="line">    <span class="keyword">public</span> GameObject debugTarget;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function">Vector2 <span class="title">getUnitPosition</span>(<span class="params">Vector3 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> x= Mathf.Floor(position.x/xUnit);</span><br><span class="line">        <span class="built_in">float</span> y= Mathf.Floor(position.z/yUnit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vector2(x, y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Vector3 <span class="title">getWorldUnitPosition</span>(<span class="params">Vector3 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> x = Mathf.Floor(position.x / xUnit) * xUnit;</span><br><span class="line">        <span class="built_in">float</span> z = Mathf.Floor(position.z / yUnit)*yUnit;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vector3(x, position.y, z);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        DisplacementRT = RenderTexture.GetTemporary(Displacement.width, Displacement.height);</span><br><span class="line">        DisplacementRT.enableRandomWrite=<span class="literal">true</span>;</span><br><span class="line">        DisplacementRT.Create();</span><br><span class="line">        Graphics.Blit(Displacement, DisplacementRT);</span><br><span class="line">        NormalRT = RenderTexture.GetTemporary(Normal.width, Normal.height);</span><br><span class="line">        NormalRT.enableRandomWrite = <span class="literal">true</span>;</span><br><span class="line">        NormalRT.Create();</span><br><span class="line">        Graphics.Blit(Normal, NormalRT);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">int</span> bufflen = texHeight * texWidth;</span><br><span class="line">        Datas = <span class="keyword">new</span> Vector4[bufflen];</span><br><span class="line">        LastDatas = <span class="keyword">new</span> Vector4[bufflen];</span><br><span class="line">        Time = <span class="keyword">new</span> <span class="built_in">float</span>[bufflen];</span><br><span class="line">        LastTime = <span class="keyword">new</span> <span class="built_in">float</span>[bufflen];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DataBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">        DataBuffer.SetData(Datas);</span><br><span class="line">        LastDataBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">        LastDataBuffer.SetData(LastDatas);</span><br><span class="line">        TimeBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">        TimeBuffer.SetData(Time);</span><br><span class="line">        LastTimeBuffer = <span class="keyword">new</span> ComputeBuffer(bufflen, <span class="number">32</span>);</span><br><span class="line">        LastTimeBuffer.SetData(Time);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        targetRT.enableRandomWrite = <span class="literal">true</span>;</span><br><span class="line">        targetRT.Create();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        xUnit = planeScale.x / (texWidth + <span class="number">0.001f</span>);</span><br><span class="line">        yUnit = planeScale.y / (texHeight + <span class="number">0.001f</span>);</span><br><span class="line">        formerPosition = getUnitPosition(transform.position);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        kl = cs.FindKernel(<span class="string">&quot;CSMain&quot;</span>);</span><br><span class="line">        kp = cs.FindKernel(<span class="string">&quot;CSPassData&quot;</span>);</span><br><span class="line"></span><br><span class="line">        cs.SetTexture(kl,<span class="string">&quot;Result&quot;</span>,targetRT);</span><br><span class="line">        cs.SetTexture(kl, <span class="string">&quot;Displacement&quot;</span>, DisplacementRT);</span><br><span class="line">        cs.SetTexture(kl, <span class="string">&quot;Normal&quot;</span>, NormalRT);</span><br><span class="line">        <span class="built_in">int</span> disWidth = Displacement.width;</span><br><span class="line">        <span class="built_in">int</span> disHeight = Displacement.height;</span><br><span class="line">        cs.SetInt(<span class="string">&quot;DisWidth&quot;</span>, disWidth);</span><br><span class="line">        cs.SetInt(<span class="string">&quot;DisHeight&quot;</span>, disHeight);</span><br><span class="line">        cs.SetTexture(kp, <span class="string">&quot;Result&quot;</span>, targetRT);</span><br><span class="line"></span><br><span class="line">        cs.SetBuffer(kl, <span class="string">&quot;DataBuffer&quot;</span>, DataBuffer);</span><br><span class="line">        cs.SetBuffer(kl, <span class="string">&quot;LastDataBuffer&quot;</span>, LastDataBuffer);</span><br><span class="line">        cs.SetBuffer(kl, <span class="string">&quot;TimeBuffer&quot;</span>, TimeBuffer);</span><br><span class="line">        cs.SetBuffer(kl, <span class="string">&quot;LastTimeBuffer&quot;</span>, LastTimeBuffer);</span><br><span class="line">        cs.SetBuffer(kp, <span class="string">&quot;DataBuffer&quot;</span>, DataBuffer);</span><br><span class="line">        cs.SetBuffer(kp, <span class="string">&quot;LastDataBuffer&quot;</span>, LastDataBuffer);</span><br><span class="line">        cs.SetBuffer(kp, <span class="string">&quot;TimeBuffer&quot;</span>, TimeBuffer);</span><br><span class="line">        cs.SetBuffer(kp, <span class="string">&quot;LastTimeBuffer&quot;</span>, LastTimeBuffer);</span><br><span class="line"></span><br><span class="line">        cs.SetFloat(<span class="string">&quot;Fade&quot;</span>, Fade);</span><br><span class="line">        cs.SetFloat(<span class="string">&quot;TrailSize&quot;</span>, TrailSize);</span><br><span class="line">        cs.SetFloat(<span class="string">&quot;Width&quot;</span>, (<span class="built_in">float</span>)texWidth);</span><br><span class="line">        cs.SetFloat(<span class="string">&quot;Height&quot;</span>, (<span class="built_in">float</span>)texHeight);</span><br><span class="line">        cs.SetFloat(<span class="string">&quot;TrailTime&quot;</span>, TrailTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DataBuffer.Release();</span><br><span class="line">        LastDataBuffer.Release();</span><br><span class="line">        TimeBuffer.Release();</span><br><span class="line">        LastTimeBuffer.Release();</span><br><span class="line">        RenderTexture.ReleaseTemporary(DisplacementRT);</span><br><span class="line">        RenderTexture.ReleaseTemporary(NormalRT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        cs.SetVector(<span class="string">&quot;FaceDirection&quot;</span>,<span class="keyword">new</span> Vector2(transform.forward.x,transform.forward.z));</span><br><span class="line">        Vector2 nowPosition=getUnitPosition(transform.position);</span><br><span class="line">        Vector2 moveVector=nowPosition-formerPosition;</span><br><span class="line">        cs.SetVector(<span class="string">&quot;MoveVector&quot;</span>, moveVector);</span><br><span class="line">       <span class="comment">// if(moveVector.sqrMagnitude&gt;0)Debug.Log(moveVector);</span></span><br><span class="line">        cs.Dispatch(kl, texWidth /<span class="number">16</span>, texHeight / <span class="number">16</span>, <span class="number">2</span>);</span><br><span class="line">        cs.Dispatch(kp, texWidth / <span class="number">16</span>, texHeight / <span class="number">32</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        formerPosition = nowPosition;</span><br><span class="line">        <span class="keyword">if</span> (snowLandMaterial != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 position = getWorldUnitPosition(transform.position - <span class="keyword">new</span> Vector3(<span class="number">0</span>, transform.localScale.y, <span class="number">0</span>));</span><br><span class="line">            snowLandMaterial.SetVector(<span class="string">&quot;_PlayerPosition&quot;</span>,position) ;</span><br><span class="line">            snowLandMaterial.SetVector(<span class="string">&quot;_SnowRange&quot;</span>, <span class="keyword">new</span> Vector4(planeScale.x/<span class="number">2</span>,transform.position.y, planeScale.y/<span class="number">2</span>,<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (snowLandGeoMaterial != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 position = getWorldUnitPosition(transform.position - <span class="keyword">new</span> Vector3(<span class="number">0</span>, transform.localScale.y, <span class="number">0</span>));</span><br><span class="line">            snowLandGeoMaterial.SetVector(<span class="string">&quot;_PlayerPosition&quot;</span>, position);</span><br><span class="line">            snowLandGeoMaterial.SetVector(<span class="string">&quot;_SnowRange&quot;</span>, <span class="keyword">new</span> Vector4(planeScale.x / <span class="number">2</span>, transform.position.y, planeScale.y / <span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总之，在这个效果里，最困难和难以处理的地方其实还是采样率不够导致的误差问题，而降低帧数的罪魁祸首一是ComputeShader使用的纹理大小（个人用的4k纹理），二是高精度的曲面细分（这个具体开到多少取决于模型本身的精度了）。在真正的项目里，我们可能做出来各种九曲十八弯的地图，碰到各种阴间的机型兼容性导致的问题，没有实际上手做的时候以为这是个非常简单的项目，但事实是解决了一个问题又会出现其它的问题，到头来只能见招拆招，真正完成了之后还是很有成就感的。<br>不过还是很有趣的，真开心啊。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://emiteinna.github.io">EmiteInna</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://emiteinna.github.io">https://emiteinna.github.io</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">此文章版权归EmiteInna所有，多看看吧。</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/image/images/qt03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/game/demo3/" title="游戏图形学数学部分"><img class="cover" src="/image/images/qt03.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">游戏图形学数学部分</div></div></a></div><div class="next-post pull-right"><a href="/game/thankyouurp/" title="整理URP目前碰到的一些问题"><img class="cover" src="/image/images/qt03.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">整理URP目前碰到的一些问题</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/images/knifesmall.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">EmiteInna</div><div class="author-info__description">和风帆大人一起建立的个人主页，和技术无关的东西估计会放b站上。主要方向是游戏程序、游戏美术和一些渲染部分，什么都做一点，但都不太会。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">86</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/emiteinna"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E2%98%86%E7%BB%88%E2%98%85%E6%95%88%E2%98%86%E6%9E%9C"><span class="toc-number">1.</span> <span class="toc-text">最☆终★效☆果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%A8%E8%BF%B9%E6%95%88%E6%9E%9C-%E8%BD%A8%E8%BF%B9%E6%B6%88%E5%A4%B1"><span class="toc-number">3.</span> <span class="toc-text">轨迹效果+轨迹消失</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">进一步优化代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%A8%E8%BF%B9%E5%BD%A2%E7%8A%B6%E5%88%B6%E4%BD%9C-%E6%B3%95%E7%BA%BF"><span class="toc-number">5.</span> <span class="toc-text">轨迹形状制作-法线</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9B%B2%E9%9D%A2%E7%BB%86%E5%88%86%E7%9C%9F%E9%A6%99"><span class="toc-number">6.</span> <span class="toc-text">曲面细分真香</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%AE%E6%8D%A2%E8%B4%B4%E5%9B%BE%E3%80%81%E9%99%84%E5%8A%A0%E6%B3%95%E7%BA%BF"><span class="toc-number">7.</span> <span class="toc-text">自定义置换贴图、附加法线</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E4%BC%98%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">其他重要优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E7%BE%8E%E6%9C%AF%E6%95%88%E6%9E%9C"><span class="toc-number">9.</span> <span class="toc-text">加入美术效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">10.</span> <span class="toc-text">代码</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/game/demo4/" title="URP轮子合集"><img src="/image/images/qt03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="URP轮子合集"/></a><div class="content"><a class="title" href="/game/demo4/" title="URP轮子合集">URP轮子合集</a><time datetime="2023-03-15T04:34:32.000Z" title="Created 2023-03-15 12:34:32">2023-03-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/game/demo2/" title="ComputeShader整活-屏幕碎裂剥落效果"><img src="/image/images/qt03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ComputeShader整活-屏幕碎裂剥落效果"/></a><div class="content"><a class="title" href="/game/demo2/" title="ComputeShader整活-屏幕碎裂剥落效果">ComputeShader整活-屏幕碎裂剥落效果</a><time datetime="2023-03-04T04:34:32.000Z" title="Created 2023-03-04 12:34:32">2023-03-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/game/demo3/" title="游戏图形学数学部分"><img src="/image/images/qt03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="游戏图形学数学部分"/></a><div class="content"><a class="title" href="/game/demo3/" title="游戏图形学数学部分">游戏图形学数学部分</a><time datetime="2023-02-24T04:34:32.000Z" title="Created 2023-02-24 12:34:32">2023-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/game/demo1/" title="ComputeShader-URP沙地/雪地上脚印/车辙效果实现"><img src="/image/images/qt03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ComputeShader-URP沙地/雪地上脚印/车辙效果实现"/></a><div class="content"><a class="title" href="/game/demo1/" title="ComputeShader-URP沙地/雪地上脚印/车辙效果实现">ComputeShader-URP沙地/雪地上脚印/车辙效果实现</a><time datetime="2023-02-20T04:34:32.000Z" title="Created 2023-02-20 12:34:32">2023-02-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/game/thankyouurp/" title="整理URP目前碰到的一些问题"><img src="/image/images/qt03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="整理URP目前碰到的一些问题"/></a><div class="content"><a class="title" href="/game/thankyouurp/" title="整理URP目前碰到的一些问题">整理URP目前碰到的一些问题</a><time datetime="2023-02-18T04:34:32.000Z" title="Created 2023-02-18 12:34:32">2023-02-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By EmiteInna</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">不必理解，只需感受；不必惊慌，因我在此。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="127,127,127" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>